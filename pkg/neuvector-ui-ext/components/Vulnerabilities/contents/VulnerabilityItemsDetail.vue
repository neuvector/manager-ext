<script>
    import ImpactTemplateButton from '../../common/buttons/ImpactTemplateButton.vue';
    import ImpactModal from '../../common/dialogs/ImpactModal.vue';
    import { getNodeBriefById, getContainerBriefById } from '../../../plugins/vulnerabilities-class';

    export default {
        props: {
            selectedVul: Object,
            isLightTheme: Boolean
        },
        data() {
            return {
                showImpactModal: false,
                brief: {
                    type: null,
                    content: null
                },
            }
        },
        components: {
            ImpactTemplateButton,
            ImpactModal,
        },
        methods: {
            openBrief({ type, id }) {
                if (type === 'node') {
                    getNodeBriefById(id).then(res => {
                        this.brief = {
                            type: 'node',
                            content: res.data.host
                        };
                        this.showImpactModal = true;
                    }).catch(err => {

                    });
                } else {
                    getContainerBriefById(id).then(res => {
                        let container = res.data.workload;
                        if (
                            container.labels &&
                            container.labels['io.kubernetes.container.name'] === 'POD'
                        ) {
                            container.images = [];
                        } else {
                            container.images = [container.image];
                        }
                        if (container.children && container.children.length > 0) {
                            container.children.forEach(child => {
                                container.images.push(child.image);
                            });
                        }
                        this.brief = {
                            type: 'workload',
                            content: container
                        }
                        this.showImpactModal = true;
                    }).catch(err => {

                    });
                }
            },
            closeImpact() {
                this.showImpactModal = false;
            }
        }
    }
</script>

<template>
    <div style="height: 400px">
        <div class="h-50">
            <p class="text-bold">Packages</p>
            <hr>
            <div style="max-height: calc(100% - 35px); overflow: auto">
                <div v-for="(value, key) in selectedVul.packages" :key="key">
                    <label class="text-info">{{ key }}</label>
                    <table
                        class="table-striped"
                        :class="{ 'table-dark': !isLightTheme }"
                        :id="key + 'package-versions'"
                        style="width: 100%">
                        <thead class="critical-row">
                            <tr class="summary-title">
                                <th>
                                    <em class="fa fa-bug text-warning mh-sm"></em>
                                    {{ t('scan.report.data.IMPACTED') }}
                                </th>
                                <th>
                                    <em class="fa fa-lightbulb-o text-primary mh-sm"></em>
                                    {{ t('scan.report.data.FIXED') }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="pkg in value" :key="pkg">
                                <td>
                                    {{ pkg.package_version }}
                                </td>
                                <td>
                                    {{ pkg.fixed_version }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="h-50">
            <p class="text-bold">Impact</p>
            <hr>
            <div style="max-height: calc(100% - 35px); overflow: auto">
                <template v-if="selectedVul.nodes?.length > 0">
                    <label class="d-block pb-1">{{ t('cis.report.data.NODES') }}</label>
                    <div class="pl-5">
                        <ImpactTemplateButton v-for="node in selectedVul.nodes" :key="node.id" :content="node" type="node" @openBrief="openBrief"></ImpactTemplateButton>
                    </div>
                </template>
                <template v-if="selectedVul.images?.length > 0">
                    <label class="d-block pb-1">{{ t('cis.report.data.IMAGES') }}</label>
                    <div class="pl-5">
                        <ImpactTemplateButton v-for="image in selectedVul.images" :key="image.id" :content="image" type="image"></ImpactTemplateButton>
                    </div>
                </template>
                <template v-if="selectedVul.workloads?.length > 0">
                    <label class="d-block pb-1">{{ t('cis.report.data.CONTAINERS') }}</label>
                    <div class="pl-5">
                        <ImpactTemplateButton v-for="workload in selectedVul.workloads" :key="workload.id" :content="workload" type="workload" @openBrief="openBrief"></ImpactTemplateButton>
                    </div>
                </template>
                <template v-if="selectedVul.platforms?.length > 0">
                    <label class="d-block pb-1">{{ t('cis.report.data.PLATFORMS') }}</label>
                    <div class="pl-5">
                        <ImpactTemplateButton v-for="platform in selectedVul.platforms" :key="platform.id" :content="platform" type="platform"></ImpactTemplateButton>
                    </div>
                </template>
            </div>
        </div>
        <ImpactModal v-if="showImpactModal" :type="brief.type" :content="brief.content" :isLightTheme="isLightTheme" @close="closeImpact"></ImpactModal>
    </div>
</template>

<style lang="scss" scoped>
.table-striped:not(.table-dark) {
    tbody tr:nth-of-type(odd) {
        background-color: #fafbfc;;
    }

    .critical-row {
        background-color: #d6e1ea !important;

        th {
            text-align: -webkit-match-parent;
        }
    }
}

.table-dark {
    color: #fff;
    background-color: #343a40;

    .critical-row th {
        text-align: -webkit-match-parent;
    }

    th,
    td,
    thead th {
        border-color: lighten(#343a40, 7.5%);
    }

    &.table-striped {
        tbody tr:nth-of-type(odd) {
            background-color: rgba(#fff, .05);
        }
    }
}
</style>